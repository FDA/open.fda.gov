function stringToTitleCase(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function numberToCommaSeparated(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")}function determineChartContent(e){var t=$(selectedTab).find("#query-count").val();return t.indexOf("primarysource.reportercountry")>=0?"primarysource.reportercountry":t.indexOf("primarysource.qualification")>=0?"primarysource.qualification":t.indexOf("serious")>=0?"serious":t.indexOf("patient.patientsex")>=0?"patient.patientsex":t.indexOf("classification")>=0?"classification":t.indexOf("classification")>=0?"classification":t.indexOf("voluntary_mandated")>=0?"voluntary_mandated":t.indexOf("receivedate")>=0||t.indexOf("drugstartdate")>=0||t.indexOf("drugenddate")>=0||t.indexOf("patient.patientdeath.patientdeathdate")>=0||t.indexOf("receiptdate")>=0||t.indexOf("receivedate")>=0||t.indexOf("transmissiondate")>=0||t.indexOf("report_date")>=0?"date":""!==t&&e.length>=1?"count":void 0}function updateResultCount(e){$(selectedTab).find("#result-count").text(numberToCommaSeparated(e)+" reports match these search parameters")}function updateCoverageChart(e,t){e-=t,c3.generate({bindto:selectedCoverageChart,data:{columns:[["Reports that don't match this search",e],["Reports that match this search",t]],type:"donut",groups:[["Reports that don't match this search","Reports that match this search"]]},color:{pattern:["#d2d2d2","#888"]},size:{height:65,width:65},margin:0,legend:{show:!1},label:{show:!1}})}function drawChartWithData(e){function t(e,t){c3.generate({bindto:selectedChart,data:{columns:[e],type:"bar"},color:{pattern:["#00539b"]},bar:{width:{ratio:.35}},axis:{rotated:!0,x:{type:"categorized",categories:t},y:{show:!1,ticks:{culling:{max:1}}}},labels:!0,size:{height:u},legend:{show:!1}})}function n(e){c3.generate({bindto:selectedChart,data:{columns:e,type:"donut"},color:{pattern:["#8bc3e0","#74a9d6","#5e8dcc","#4a6fc2","#3751b8","#8be095","#74d674"]},labels:!0,size:{height:u},legend:{show:!0,position:"right"}})}function a(e,t){c3.generate({bindto:selectedChart,data:{x:"Date",x_format:"%Y%m",columns:[t,e]},point:{show:!1},color:{pattern:["#00539b"]},axis:{x:{type:"timeseries",tick:{format:"%Y-%m",culling:{max:4}}},y:{tick:{culling:{max:4}}}},legend:{show:!1},size:{height:u}})}function r(e,t,n){$.each(e,function(e,a){var r=[];$.each(a,function(e,n){r.push(t(e,n))}),"bar"===n?(i.push(r[0]),s.push(r[1])):s.push(r)})}function o(e,t,n){var a=d3.nest().key(function(e){return e.time.slice(0,6)}).rollup(function(e){return d3.sum(e,function(e){return e.count})}).entries(e);a.map(function(e){n.push(e.key),t.push(e.values)})}var i=[],s=[],c=determineChartContent(e),u=300;if("count"===c){s.push("# of matching reports"),e=e.slice(0,10);var d=function(e,t){return"term"==e&&(t=t.toLowerCase()),t};r(e,d,"bar"),t(s,i)}else if("date"===c)s.push("Reports"),i.push("Date"),o(e,s,i),a(s,i);else if("primarysource.qualification"===c){e=e.slice(0,5);var d=function(e,t){return"term"==e&&("1"==t?t="Physician":"2"==t?t="Pharmacist":"3"==t?t="Other health professional":"4"==t?t="Lawyer":"5"==t&&(t="Consumer or non-health professional")),t};r(e,d,"donut"),n(s)}else if("primarysource.reportercountry"===c){s.push("Reporter country"),e=e.slice(0,10);var d=function(e,t){return"term"==e&&(t=stringToTitleCase(t)),t};r(e,d,"bar"),t(s,i)}else if("serious"===c){e=e.slice(0,2);var d=function(e,t){return"term"==e&&("1"==t?t="Death, life threatening condition, hospitalization, disability, congenital anomali, or other serious condition":"2"==t&&(t="Other")),t};r(e,d,"donut"),n(s)}else if("patient.patientsex"===c){e=e.slice(0,3);var d=function(e,t){return"term"==e&&("1"==t?t="Male":"2"==t?t="Female":"0"==t&&(t="Other")),t};r(e,d,"donut"),n(s)}else if("classification"===c){e=e.slice(0,3);var d=function(e,t){return t};r(e,d,"donut"),n(s)}else if("voluntary_mandated"===c){e=e.slice(0,2);var d=function(e,t){return t};r(e,d,"donut"),n(s)}else console.log("Not countable")}function runQueries(e,t){$.getJSON(t).success(function(e){drawChartWithData(e.results)}).fail(function(){console.log("fails"),$(selectedTab).find("#query-endpoint").popover({trigger:"manual",container:"body",placement:"top",content:"Oh no! The API query failed. It's probably due to a syntax error (double-check the query and spelling), or because the API couldn't be reached."}).on("shown.bs.popover",function(){setTimeout(function(){$(selectedTab).find("#query-endpoint").popover("hide")},7e3)}),$(selectedTab).find("#query-endpoint").popover("show")}),$.getJSON(e,function(e){var t=e.meta.results.total;updateCoverageChart(maxNumberOfRecords,t),updateResultCount(t)})}function constructAndExecuteQuery(){var e=endpoint,t=$(selectedTab).find("#query-search").val(),n=$(selectedTab).find("#query-count").val(),a=e;""!=t&&(a+="search="+t),""==t&&(a=e+"search="+countTerm+"&limit=1"),""!=t&&(e+="search="+t),""!=n&&(e+="&count="+n),runQueries(a,e),$(selectedTab).find("#query-endpoint").text(e)}var selectedTab=$(".tab-content > .tab-pane.active"),selectedChart=$(selectedTab).find("#chart")[0],selectedCoverageChart=$(selectedTab).find("#chart-coverage")[0],maxNumberOfRecords;$(document).ready(function(){constructAndExecuteQuery(),$.getJSON(endpoint+"search="+countTerm,function(e){maxNumberOfRecords=e.meta.results.total}),$(selectedTab).find("#query-button").on("click",function(){constructAndExecuteQuery()}),$('a[data-toggle="pill"]').on("shown.bs.tab",function(e){selectedTab=$(".tab-content > .tab-pane.active"),selectedChart=$(selectedTab).find("#chart")[0],selectedCoverageChart=$(selectedTab).find("#chart-coverage")[0],$(e.relatedTarget[0]).find("#query-button").off("click"),$(selectedTab).find("#query-button").on("click",function(){constructAndExecuteQuery()});var t=$(selectedTab).find("input[name=api-query-options-search]:radio")[0];$(t).trigger("click"),constructAndExecuteQuery(),$("textarea").autosize().show().trigger("autosize.resize")})}),$(".tab-pane").find("input[name=api-query-options-search]:radio").change(function(){var e=$(".tab-pane").find("#query-search"),t=$(this).val();e.val(t),$(selectedTab).find("#query-button").trigger("click"),$("textarea").autosize().trigger("autosize.resize")}),$(".query-textarea").keypress(function(e){var t=e.keyCode?e.keyCode:e.which,n=$(this).parents(".tab-pane").find("#query-button");$(this).parents(".api-query-options").find("input").prop("checked",!1),32===t?e.preventDefault():13===t&&(e.preventDefault(),$(n).trigger("click"))}),Modernizr.svg||($("#api-demo").hide(),$("#api-demo-no-svg").show());